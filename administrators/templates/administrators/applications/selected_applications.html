{% extends 'ta_app/base.html' %}
{% block content %}

{% include 'administrators/_menu.html' %}
<div>
  {% include 'ta_app/pages/_header.html' with title='Selected Applications' text=selected_applications|length %}

  <div class="search-field bg-light-gray p-4">
    <form method="GET">
      <input type="text" name="year" value="{{ request.GET.year }}" placeholder="Year" /> and
      <input type="text" name="term" value="{{ request.GET.term }}" placeholder="Term" /> <br />
      <input type="text" name="code" value="{{ request.GET.code }}" placeholder="Job Code" /> and
      <input type="text" name="number" value="{{ request.GET.number }}" placeholder="Job Number" /> and
      <input type="text" name="section" value="{{ request.GET.section }}" placeholder="Job Section" /> <br />
      <input type="text" name="cwl" value="{{ request.GET.cwl }}" placeholder="CWL" /> <br />
      <button class="btn btn-sm btn-secondary" type="submit" name="action">Search</button>
      <a class="btn btn-sm btn-light" href="{% url 'administrators:selected_applications' %}">Clear</a>
    </form>
  </div>

  <div>
    <table
      class="table table-bordered table-hover table-striped table-responsive-md text-center"
      data-toggle="table"
      data-sortable="true"
      data-classes=""
      data-pagination="true"
      data-search="true"
      data-page-size="50"
      data-page-list="[50, 100, All]"
      data-show-export="true"
      data-click-to-select="true"
      data-show-columns="true"
    >
      <thead>
        <tr>
          <th data-sortable="true">ID</th>
          <th data-sortable="true">Year</th>
          <th data-sortable="true">Term</th>
          <th data-sortable="true">Job</th>
          <th data-sortable="true">Applicant</th>
          <th>Resume</th>
          <th data-sortable="true">Instructor<br /> Preference</th>
          <th data-sortable="true">Classification</th>
          <th>Note</th>
          <th data-sortable="true">Created at</th>
          <th data-sortable="true">Updated at</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for app in selected_applications %}
          <tr>
            <td>
              <a class="btn btn-xs btn-info" href="{% url 'administrators:show_application' app_slug=app.slug path='selected' %}">{{ app.id }}</a>
            </td>
            <td>{{ app.job.session.year }}</td>
            <td>{{ app.job.session.term.code }}</td>
            <td>
              <a href="{% url 'administrators:show_job' session_slug=app.job.session.slug job_slug=app.job.course.slug path='selected' %}">
                {{ app.job.course.code.name }} {{ app.job.course.number.name }} {{ app.job.course.section.name }}
              </a>
            </td>
            <td>
              <a href="{% url 'administrators:show_user' username=app.applicant.username path='selected' %}">{{ app.applicant.get_full_name }}</a>
            </td>
            <td>
              {% if app.resume_file %}
                <a href="{% url 'students:download_resume' username=app.applicant.username filename=app.resume_file %}" target="_blank">{{ app.resume_file }}</a>
              {% else %}
                No
              {% endif %}
            </td>
            <td>
              {% include 'ta_app/applications/_app_instructor_preference.html' with data=app.get_instructor_preference_display %}
            </td>
            <td>
              {% if app.classification %}
                {{ app.classification.name }}
              {% else %}
                None
              {% endif %}
            </td>
            <td>
              {% if app.note %}
                {% include 'ta_app/applications/_modal_note.html' with data=app %}
              {% else %}
                None
              {% endif %}
            </td>
            <td>{{ app.created_at }}</td>
            <td>{{ app.updated_at }}</td>
            <td>
              {% if app.offered %}
                <span class="badge badge-secondary">OFFERED</span><br />
                <small class="text-muted">{{ app.offered.created_at }}</small>

              {% else %}
                <button class="btn btn-xs btn-primary" type="button" data-toggle="modal" data-target="#job-application-offer-modal-{{ app.id }}">Offer</button>

                <div class="modal fade" id="job-application-offer-modal-{{ app.id }}" tabindex="-1" role="dialog" aria-labelledby="job-application-offer-modal-label-{{ app.id }}" aria-hidden="true">
                  <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="job-application-offer-modal-label-{{ app.id }}">Offer</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      </div>
                      <div class="modal-body text-left">

                        <h4>
                          To {{ app.applicant.get_full_name }} <small class="text-muted">({{ app.applicant.username }})</small>
                        </h4>
                        <h6 class="text-secondary mb-3">for {{ app.job.session.year }} {{ app.job.session.term.code }} - {{ app.job.course.code.name }} {{ app.job.course.number.name }} {{ app.job.course.section.name }}</h6>

                        <form action="{% url 'administrators:offer_job' session_slug=app.job.session.slug job_slug=app.job.course.slug %}" method="post">
                          {% csrf_token %}
                          <table class="table table-borderless">
                            <tr>
                              <td>
                                <span class="font-weight-bold">Classification:</span>
                              </td>
                              <td>
                                <select name="classification">
                                  <option value="">Select</option>
                                  {% for choice in classification_choices %}
                                    {% if choice.id == app.classification.id %}
                                      <option value="{{ choice.id }}" selected>{{ choice.year }} {{ choice.name }}</option>
                                    {% else %}
                                      <option value="{{ choice.id }}">{{ choice.year }} {{ choice.name }}</option>
                                    {% endif %}
                                  {% endfor %}
                                </select>
                              </td>
                            </tr>
                            <tr>
                              <td>
                                <span class="font-weight-bold">Note:</span>
                              </td>
                              <td>
                                <textarea name="note" rows="2" cols="40">{% if app.note %} {{ app.note }} {% endif %}</textarea>
                              </td>
                            </tr>
                            <tr>
                              <td>
                                <span class="font-weight-bold">Assigned Hours:</span>
                              </td>
                              <td>
                                <input type="number" name="assigned_hours" value="{{ app.selected.assigned_hours }}" />
                              </td>
                            </tr>
                          </table>

                          <input type="hidden" name="application" value="{{ app.id }}" />
                          <input type="hidden" name="assigned" value="{{ app_status_code.offered }}" />
                          <input type="hidden" name="applicant" value="{{ app.applicant.id }}" />

                          <input class="btn btn-primary" type="submit" value="Offer" />
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}

            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

{% endblock %}
